<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title># pg_restore使用</title>
<style>
@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAYcAA0AAAAACjQAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABMAAAABwAAAAca8vGTk9TLzIAAAFMAAAARAAAAFZG1VHVY21hcAAAAZAAAAA+AAABQgAP9AdjdnQgAAAB0AAAAAQAAAAEACICiGdhc3AAAAHUAAAACAAAAAj//wADZ2x5ZgAAAdwAAADRAAABEKyikaNoZWFkAAACsAAAAC0AAAA2AtXoA2hoZWEAAALgAAAAHAAAACQHngNFaG10eAAAAvwAAAAQAAAAEAwAACJsb2NhAAADDAAAAAoAAAAKALIAVG1heHAAAAMYAAAAHwAAACABEAB2bmFtZQAAAzgAAALBAAAFu3I9x/Nwb3N0AAAF/AAAAB0AAAAvaoFvbwAAAAEAAAAAzBdyYwAAAADP2IQvAAAAAM/bz7t4nGNgZGFgnMDAysDB1Ml0hoGBoR9CM75mMGLkYGBgYmBlZsAKAtJcUxgcPsR8iGF2+O/AEMPsznAYKMwIkgMA5REMOXicY2BgYGaAYBkGRgYQsAHyGMF8FgYFIM0ChED+h5j//yEk/3KoSgZGNgYYk4GRCUgwMaACRoZhDwCs7QgGAAAAIgKIAAAAAf//AAJ4nHWMMQrCQBBF/0zWrCCIKUQsTDCL2EXMohYGSSmorScInsRGL2DOYJe0Ntp7BK+gJ1BxF1stZvjz/v8DRghQzEc4kIgKwiAppcA9LtzKLSkdNhKFY3HF4lK69ExKslx7Xa+vPRVS43G98vG1DnkDMIBUgFN0MDXflU8tbaZOUkXUH0+U27RoRpOIyCKjbMCVejwypzJJG4jIwb43rfl6wbwanocrJm9XFYfskuVC5K/TPyczNU7b84CXcbxks1Un6H6tLH9vf2LRnn8Ax7A5WQAAAHicY2BkYGAA4teL1+yI57f5ysDNwgAC529f0kOmWRiYVgEpDgYmEA8AUzEKsQAAAHicY2BkYGB2+O/AEMPCAAJAkpEBFbAAADgKAe0EAAAiAAAAAAQAAAAEAAAAAAAAKgAqACoAiAAAeJxjYGRgYGBhsGFgYgABEMkFhAwM/xn0QAIAD6YBhwB4nI1Ty07cMBS9QwKlQapQW3VXySvEqDCZGbGaHULiIQ1FKgjWMxknMfLEke2A+IJu+wntrt/QbVf9gG75jK577Lg8K1qQPCfnnnt8fX1NRC/pmjrk/zprC+8D7tBy9DHgBXoWfQ44Av8t4Bj4Z8CLtBL9CniJluPXASf0Lm4CXqFX8Q84dOLnMB17N4c7tBo1AS/Qi+hTwBH4rwHHwN8DXqQ30XXAS7QaLwSc0Gn8NuAVWou/gFmnjLrEaEh9GmDdDGgL3B4JsrRPDU2hTOiMSuJUIdKQQayiAth69r6akSSFqIJuA19TrzCIaY8sIoxyrNIrL//pw7A2iMygkX5vDj+G+kuoLdX4GlGK/8Lnlz6/h9MpmoO9rafrz7ILXEHHaAx95s9lsI7AHNMBWEZHULnfAXwG9/ZqdzLI08iuwRloXE8kfhXYAvE23+23DU3t626rbs8/8adv+9DWknsHp3E17oCf+Z48rvEQNZ78paYM38qfk3v/u3l3u3GXN2Dmvmvpf1Srwk3pB/VSsp512bA/GG5i2WJ7wu430yQ5K3nFGiOqgtmSB5pJVSizwaacmUZzZhXLlZTq8qGGFY2YcSkqbth6aW1tRmlaCFs2016m5qn36SbJrqosG4uMV4aP2PHBmB3tjtmgN2izkGQyLWprekbIntJFing32a5rKWCN/SdSoga45EJykyQ7asZvHQ8PTm6cslIpwyeyjbVltNikc2HTR7YKh9LBl9DADC0U/jLcBZDKrMhUBfQBvXRzLtFtjU9eNHKin0x5InTqb8lNpfKv1s1xHzTXRqgKzek/mb7nB8RZTCDhGEX3kK/8Q75AmUM/eLkfA+0Hi908Kx4eNsMgudg5GLdRD7a84npi+YxNr5i5KIbW5izXas7cHXIMAau1OueZhfj+cOcP3P8MNIWLyYOBuxL6DRylJ4cAAAB4nGNgYoAALjDJyIAOWMCiTIxMLDmZedkABtIBygAAAA==) format('woff');
}

body {
  background-color: white;
}

.markdown-body {
  min-width: 200px;
  max-width: 760px;
  margin: 0 auto;
  padding: 30px;

  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .anchor {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  height: 1em;
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body .highlight {
  background: #fff;
}

.markdown-body .highlight .mf,
.markdown-body .highlight .mh,
.markdown-body .highlight .mi,
.markdown-body .highlight .mo,
.markdown-body .highlight .il,
.markdown-body .highlight .m {
  color: #945277;
}

.markdown-body .highlight .s,
.markdown-body .highlight .sb,
.markdown-body .highlight .sc,
.markdown-body .highlight .sd,
.markdown-body .highlight .s2,
.markdown-body .highlight .se,
.markdown-body .highlight .sh,
.markdown-body .highlight .si,
.markdown-body .highlight .sx,
.markdown-body .highlight .s1 {
  color: #df5000;
}

.markdown-body .highlight .kc,
.markdown-body .highlight .kd,
.markdown-body .highlight .kn,
.markdown-body .highlight .kp,
.markdown-body .highlight .kr,
.markdown-body .highlight .kt,
.markdown-body .highlight .k,
.markdown-body .highlight .o {
  font-weight: bold;
}

.markdown-body .highlight .kt {
  color: #458;
}

.markdown-body .highlight .c,
.markdown-body .highlight .cm,
.markdown-body .highlight .c1 {
  color: #998;
  font-style: italic;
}

.markdown-body .highlight .cp,
.markdown-body .highlight .cs {
  color: #999;
  font-weight: bold;
}

.markdown-body .highlight .cs {
  font-style: italic;
}

.markdown-body .highlight .n {
  color: #333;
}

.markdown-body .highlight .na,
.markdown-body .highlight .nv,
.markdown-body .highlight .vc,
.markdown-body .highlight .vg,
.markdown-body .highlight .vi {
  color: #008080;
}

.markdown-body .highlight .nb {
  color: #0086B3;
}

.markdown-body .highlight .nc {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .no {
  color: #094e99;
}

.markdown-body .highlight .ni {
  color: #800080;
}

.markdown-body .highlight .ne {
  color: #990000;
  font-weight: bold;
}

.markdown-body .highlight .nf {
  color: #945277;
  font-weight: bold;
}

.markdown-body .highlight .nn {
  color: #555;
}

.markdown-body .highlight .nt {
  color: #000080;
}

.markdown-body .highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}

.markdown-body .highlight .gd {
  color: #000;
  background-color: #fdd;
}

.markdown-body .highlight .gd .x {
  color: #000;
  background-color: #faa;
}

.markdown-body .highlight .ge {
  font-style: italic;
}

.markdown-body .highlight .gr {
  color: #aa0000;
}

.markdown-body .highlight .gh {
  color: #999;
}

.markdown-body .highlight .gi {
  color: #000;
  background-color: #dfd;
}

.markdown-body .highlight .gi .x {
  color: #000;
  background-color: #afa;
}

.markdown-body .highlight .go {
  color: #888;
}

.markdown-body .highlight .gp {
  color: #555;
}

.markdown-body .highlight .gs {
  font-weight: bold;
}

.markdown-body .highlight .gu {
  color: #800080;
  font-weight: bold;
}

.markdown-body .highlight .gt {
  color: #aa0000;
}

.markdown-body .highlight .ow {
  font-weight: bold;
}

.markdown-body .highlight .w {
  color: #bbb;
}

.markdown-body .highlight .sr {
  color: #017936;
}

.markdown-body .highlight .ss {
  color: #8b467f;
}

.markdown-body .highlight .bp {
  color: #999;
}

.markdown-body .highlight .gc {
  color: #999;
  background-color: #EAF2F5;
}

.markdown-body .octicon {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  float: left;
  margin: 0.3em 0 0.25em -1.6em;
  vertical-align: middle;
}

/*

github.com style (c) Vasily Polovnyov <vast@whiteants.net>

*/

.hljs {
  display: block;
  overflow-x: auto;
  padding: 0.5em;
  color: #333;
  background: #f8f8f8;
  -webkit-text-size-adjust: none;
}

.hljs-comment,
.diff .hljs-header {
  color: #998;
  font-style: italic;
}

.hljs-keyword,
.css .rule .hljs-keyword,
.hljs-winutils,
.nginx .hljs-title,
.hljs-subst,
.hljs-request,
.hljs-status {
  color: #333;
  font-weight: bold;
}

.hljs-number,
.hljs-hexcolor,
.ruby .hljs-constant {
  color: #008080;
}

.hljs-string,
.hljs-tag .hljs-value,
.hljs-doctag,
.tex .hljs-formula {
  color: #d14;
}

.hljs-title,
.hljs-id,
.scss .hljs-preprocessor {
  color: #900;
  font-weight: bold;
}

.hljs-list .hljs-keyword,
.hljs-subst {
  font-weight: normal;
}

.hljs-class .hljs-title,
.hljs-type,
.vhdl .hljs-literal,
.tex .hljs-command {
  color: #458;
  font-weight: bold;
}

.hljs-tag,
.hljs-tag .hljs-title,
.hljs-rule .hljs-property,
.django .hljs-tag .hljs-keyword {
  color: #000080;
  font-weight: normal;
}

.hljs-attribute,
.hljs-variable,
.lisp .hljs-body,
.hljs-name {
  color: #008080;
}

.hljs-regexp {
  color: #009926;
}

.hljs-symbol,
.ruby .hljs-symbol .hljs-string,
.lisp .hljs-keyword,
.clojure .hljs-keyword,
.scheme .hljs-keyword,
.tex .hljs-special,
.hljs-prompt {
  color: #990073;
}

.hljs-built_in {
  color: #0086b3;
}

.hljs-preprocessor,
.hljs-pragma,
.hljs-pi,
.hljs-doctype,
.hljs-shebang,
.hljs-cdata {
  color: #999;
  font-weight: bold;
}

.hljs-deletion {
  background: #fdd;
}

.hljs-addition {
  background: #dfd;
}

.diff .hljs-change {
  background: #0086b3;
}

.hljs-chunk {
  color: #aaa;
}


</style>

<style> @media print{ .hljs{overflow: visible; word-wrap: break-word !important;} }</style></head><body><div class="markdown-body">
<h1 id="toc_0">pg_restore使用</h1>

<ul>
<li>
<a href="#toc_0">pg_restore使用</a>
<ul>
<li>
<a href="#toc_1">1.pg_restore 官方帮助</a>
</li>
<li>
<a href="#toc_2">2. 具体的一些例子</a>
<ul>
<li>
<a href="#toc_3">2.1 恢复整个database</a>
<ul>
<li>
<a href="#toc_4">恢复到原来的dbname：</a>
</li>
<li>
<a href="#toc_5">恢复到新的dbname中：</a>
</li>
</ul>
</li>
<li>
<a href="#toc_6">2.2 列出备份文件包含的内容</a>
</li>
<li>
<a href="#toc_7">2.3 恢复表和索引</a>
<ul>
<li>
<a href="#toc_8">恢复表定义</a>
</li>
<li>
<a href="#toc_9">恢复表数据</a>
</li>
<li>
<a href="#toc_10">表中有数据的时候需要注意</a>
</li>
<li>
<a href="#toc_11">恢复索引</a>
</li>
</ul>
</li>
<li>
<a href="#toc_12">2.4 恢复其他对象的定义</a>
<ul>
<li>
<a href="#toc_13">恢复触发器</a>
</li>
<li>
<a href="#toc_14">恢复函数</a>
</li>
</ul>
</li>
<li>
<a href="#toc_15">2.5 其他一些参数选项</a>
</li>
</ul>
</li>
<li>
<a href="#toc_16">3.待加强的功能</a>
</li>
</ul>
</li>
</ul>


<blockquote>
<p>当前版本： PG 9.5.3</p>
</blockquote>

<h2 id="toc_1">1.pg_restore 官方帮助</h2>

<pre><code>
[postgres@dang-db dump]$$PGHOME/bin/pg_restore --help

pg_restore restores a PostgreSQL database from an archive created by pg_dump.



Usage:

  pg_restore [OPTION]... [FILE]



General options:

  -d, --dbname=NAME        connect to database name

  -f, --file=FILENAME      output file name

  -F, --format=c|d|t       backup file format (should be automatic)

  -l, --list               print summarized TOC of the archive

  -v, --verbose            verbose mode

  -V, --version            output version information, then exit

  -?, --help               show this help, then exit



Options controlling the restore:

  -a, --data-only              restore only the data, no schema

  -c, --clean                  clean (drop) database objects before recreating

  -C, --create                 create the target database

  -e, --exit-on-error          exit on error, default is to continue

  -I, --index=NAME             restore named index

  -j, --jobs=NUM               use this many parallel jobs to restore

  -L, --use-list=FILENAME      use table of contents from this file for

                               selecting/ordering output

  -n, --schema=NAME            restore only objects in this schema

  -O, --no-owner               skip restoration of object ownership

  -P, --function=NAME(args)    restore named function

  -s, --schema-only            restore only the schema, no data

  -S, --superuser=NAME         superuser user name to use for disabling triggers

  -t, --table=NAME             restore named table

  -T, --trigger=NAME           restore named trigger

  -x, --no-privileges          skip restoration of access privileges (grant/revoke)

  -1, --single-transaction     restore as a single transaction

  --disable-triggers           disable triggers during data-only restore

  --enable-row-security        enable row security

  --if-exists                  use IF EXISTS when dropping objects

  --no-data-for-failed-tables  do not restore data of tables that could not be

                               created

  --no-security-labels         do not restore security labels

  --no-tablespaces             do not restore tablespace assignments

  --section=SECTION            restore named section (pre-data, data, or post-data)

  --use-set-session-authorization

                               use SET SESSION AUTHORIZATION commands instead of

                               ALTER OWNER commands to set ownership



Connection options:

  -h, --host=HOSTNAME      database server host or socket directory

  -p, --port=PORT          database server port number

  -U, --username=NAME      connect as specified database user

  -w, --no-password        never prompt for password

  -W, --password           force password prompt (should happen automatically)

  --role=ROLENAME          do SET ROLE before restore



The options -I, -n, -P, -t, -T, and --section can be combined and specified

multiple times to select multiple objects.



If no input file name is supplied, then standard input is used.



Report bugs to &lt;pgsql-bugs@postgresql.org&gt;.

</code></pre>

<h2 id="toc_2">2. 具体的一些例子</h2>

<h3 id="toc_3">2.1 恢复整个database</h3>

<h4 id="toc_4">恢复到原来的dbname：</h4>

<pre><code>
$PGHOME/bin/pg_dump -Fc testdb  -f testdb.dump



[postgres@dang-db dump]$$PGHOME/bin/psql -c &#39;drop database testdb;&#39;

DROP DATABASE

[postgres@dang-db dump]$$PGHOME/bin/psql -l

                                  List of databases

   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   

-----------+----------+----------+-------------+-------------+-----------------------

 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +

           |          |          |             |             | postgres=CTc/postgres

 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +

           |          |          |             |             | postgres=CTc/postgres

 testdb02  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

(4 rows)



[postgres@dang-db dump]$$PGHOME/bin/pg_restore -C -d postgres testdb.dump &amp;

[1] 30022

[postgres@dang-db dump]$

[1]+  Done                    $PGHOME/bin/pg_restore -C -d postgres testdb.dump

[postgres@dang-db dump]$$PGHOME/bin/psql -l

                                  List of databases

   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   

-----------+----------+----------+-------------+-------------+-----------------------

 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +

           |          |          |             |             | postgres=CTc/postgres

 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +

           |          |          |             |             | postgres=CTc/postgres

 testdb    | user01   | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

 testdb02  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

(5 rows)



[postgres@dang-db dump]$$PGHOME/bin/psql -d testdb -U user01 -c &#39;select count(*) from test;&#39;

  count  

---------

 1000000

(1 row)

$PGHOME/bin/pg_restore -C -d testdb01 testdb.dump

</code></pre>

<h4 id="toc_5">恢复到新的dbname中：</h4>

<pre><code>


[postgres@dang-db dump]$$PGHOME/bin/createdb -T template0 testdb01;

[postgres@dang-db dump]$$PGHOME/bin/pg_restore  -d testdb01 testdb.dump &amp;

[1] 30125

[postgres@dang-db dump]$

[postgres@dang-db dump]$

[1]+  Done                    $PGHOME/bin/pg_restore -d testdb01 testdb.dump

[postgres@dang-db dump]$$PGHOME/bin/psql -l

                                  List of databases

   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   

-----------+----------+----------+-------------+-------------+-----------------------

 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +

           |          |          |             |             | postgres=CTc/postgres

 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +

           |          |          |             |             | postgres=CTc/postgres

 testdb    | user01   | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

 testdb01  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

 testdb02  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 

(6 rows)



[postgres@dang-db dump]$$PGHOME/bin/psql -d testdb01 -U user01 -c &#39;select count(*) from test;&#39;

  count  

---------

 1000000

(1 row)

</code></pre>

<p>同时在恢复的时候，可以添加 -j参数来利用并行提高恢复的速度。</p>

<pre><code>
$PGHOME/bin/pg_restore -d testdb01 -j 5testdb.dump

</code></pre>

<h3 id="toc_6">2.2 列出备份文件包含的内容</h3>

<p>在拿到一个备份文件的时候，如果不知备份的来源，可以通过pg_restore提供的 -l 参数来查看备份文件中都包含哪些内容</p>

<pre><code>


[postgres@dang-db dump]$$PGHOME/bin/pg_restore -l testdb.dump

;

; Archive created at 2016-08-12 16:48:36 CST

;     dbname: testdb

;     TOC Entries: 23

;     Compression: -1

;     Dump Version: 1.12-0

;     Format: CUSTOM

;     Integer: 4 bytes

;     Offset: 8 bytes

;     Dumped from database version: 9.5.3

;     Dumped by pg_dump version: 9.5.3

;

;

; Selected TOC Entries:

;

2991; 1262 16416 DATABASE - testdb user01

6; 2615 2200 SCHEMA - public postgres

2992; 0 0 COMMENT - SCHEMA public postgres

2993; 0 0 ACL - public postgres

8; 2615 16417 SCHEMA - user01 user01

9; 2615 24579 SCHEMA - user02 user01

1; 3079 13223 EXTENSION - plpgsql 

2994; 0 0 COMMENT - EXTENSION plpgsql 

188; 1255 24576 FUNCTION user01 add(integer, numeric) user01

186; 1259 24586 TABLE public test postgres

184; 1259 24577 SEQUENCE user01 seq_test user01

183; 1259 16432 TABLE user01 test user01

2995; 0 0 COMMENT user01 TABLE test user01

187; 1259 24592 TABLE user01 test02 user01

185; 1259 24580 TABLE user02 test01 user01

2985; 0 24586 TABLE DATA public test postgres

2996; 0 0 SEQUENCE SET user01 seq_test user01

2982; 0 16432 TABLE DATA user01 test user01

2986; 0 24592 TABLE DATA user01 test02 user01

2984; 0 24580 TABLE DATA user02 test01 user01

2867; 2606 16439 CONSTRAINT user01 test_pkey user01

</code></pre>

<p>在上面输出信息的基础上，可以结合 -n 或者 -t 来进一步缩小范围</p>

<pre><code class="language-shell">
[postgres@dang-db dump]$$PGHOME/bin/pg_restore -l -n user01 testdb.dump

;

; Archive created at 2016-08-12 16:48:36 CST

;     dbname: testdb

;     TOC Entries: 23

;     Compression: -1

;     Dump Version: 1.12-0

;     Format: CUSTOM

;     Integer: 4 bytes

;     Offset: 8 bytes

;     Dumped from database version: 9.5.3

;     Dumped by pg_dump version: 9.5.3

;

;

; Selected TOC Entries:

;

188; 1255 24576 FUNCTION user01 add(integer, numeric) user01

184; 1259 24577 SEQUENCE user01 seq_test user01

183; 1259 16432 TABLE user01 test user01

2995; 0 0 COMMENT user01 TABLE test user01

187; 1259 24592 TABLE user01 test02 user01

2996; 0 0 SEQUENCE SET user01 seq_test user01

2982; 0 16432 TABLE DATA user01 test user01

2986; 0 24592 TABLE DATA user01 test02 user01

2867; 2606 16439 CONSTRAINT user01 test_pkey user01



[postgres@dang-db dump]$$PGHOME/bin/pg_restore -l  -n user01 -t &#39;test&#39; testdb.dump  

;

; Archive created at 2016-08-12 16:48:36 CST

;     dbname: testdb

;     TOC Entries: 23

;     Compression: -1

;     Dump Version: 1.12-0

;     Format: CUSTOM

;     Integer: 4 bytes

;     Offset: 8 bytes

;     Dumped from database version: 9.5.3

;     Dumped by pg_dump version: 9.5.3

;

;

; Selected TOC Entries:

;

183; 1259 16432 TABLE user01 test user01

2982; 0 16432 TABLE DATA user01 test user01

</code></pre>

<p>与pg_dump 不同的是，pg_restore的 -t -n 不能使用通配符，在restore的时候需要注意。</p>

<p>同时，restore提供了一个参数 -L 来从配置文件中读取需要恢复的对象或数据，而配置文件则可以通过 -l 来生成。</p>

<p>生成schema user01的配置文件：</p>

<pre><code>[postgres@dang-db dump]$$PGHOME/bin/pg_restore -l  -n user01 testdb.dump &gt; user01.lst

[postgres@dang-db dump]$

[postgres@dang-db dump]$more user01.lst 

;

; Archive created at 2016-08-12 16:48:36 CST

;     dbname: testdb

;     TOC Entries: 23

;     Compression: -1

;     Dump Version: 1.12-0

;     Format: CUSTOM

;     Integer: 4 bytes

;     Offset: 8 bytes

;     Dumped from database version: 9.5.3

;     Dumped by pg_dump version: 9.5.3

;

;

; Selected TOC Entries:

;

188; 1255 24576 FUNCTION user01 add(integer, numeric) user01

184; 1259 24577 SEQUENCE user01 seq_test user01

183; 1259 16432 TABLE user01 test user01

2995; 0 0 COMMENT user01 TABLE test user01

187; 1259 24592 TABLE user01 test02 user01

2996; 0 0 SEQUENCE SET user01 seq_test user01

2982; 0 16432 TABLE DATA user01 test user01

2986; 0 24592 TABLE DATA user01 test02 user01

2867; 2606 16439 CONSTRAINT user01 test_pkey user01

</code></pre>

<p>删除 schema user01后新建schema</p>

<pre><code>
postgres@testdb:5532 # drop schema user01 cascade;

NOTICE:  drop cascades to 4 other objects

DETAIL:  drop cascades to function user01.add(integer,numeric)

drop cascades to sequence user01.seq_test

drop cascades to table user01.test02

drop cascades to table user01.t01

DROP SCHEMA

postgres@testdb:5532 # \dn

  List of schemas

  Name  |  Owner   

--------+----------

 public | postgres

 user02 | user01

(2 rows)

postgres@testdb:5532 # create schema user01 authorization user01;  

CREATE SCHEMA

</code></pre>

<p>利用配置文件恢复 schema user01中的对象</p>

<pre><code>
$PGHOME/bin/pg_restore -L user01.lst testdb.dump &amp;

[postgres@dang-db dump]$$PGHOME/bin/psql -d testdb -U user01 -c &#39;select count(*) from test;&#39;

  count  

---------

 1000000

(1 row)

</code></pre>

<h3 id="toc_7">2.3 恢复表和索引</h3>

<h4 id="toc_8">恢复表定义</h4>

<pre><code>
user01@testdb:5532 &gt; \d+ test

                         Table &quot;user01.test&quot;

 Column |  Type   | Modifiers | Storage  | Stats target | Description 

--------+---------+-----------+----------+--------------+-------------

 id     | integer | not null  | plain    |              | 

 name   | text    |           | extended |              | 

Indexes:

    &quot;test_pkey&quot; PRIMARY KEY, btree (id)



user01@testdb:5532 &gt; drop table test;

DROP TABLE

user01@testdb:5532 &gt; \d+ user01.test

Did not find any relation named &quot;user01.test&quot;.

$PGHOME/bin/pg_restore -s -t test -n user01 testdb.dump -d testdb 

user01@testdb:5532 &gt; \d+ test

                         Table &quot;user01.test&quot;

 Column |  Type   | Modifiers | Storage  | Stats target | Description 

--------+---------+-----------+----------+--------------+-------------

 id     | integer | not null  | plain    |              | 

 name   | text    |           | extended |              | 



user01@testdb:5532 &gt; select count(*) from test;

 count 

-------

     0

(1 row)




</code></pre>

<h4 id="toc_9">恢复表数据</h4>

<pre><code>
$PGHOME/bin/pg_restore -a -t test -n user01 testdb.dump -d testdb 

user01@testdb:5532 &gt; select count(*) from test;

  count  

---------

 1000000

(1 row)

</code></pre>

<h4 id="toc_10">表中有数据的时候需要注意</h4>

<p>如果在导入的时候，表已经存在，表中的数据默认情况下还会继续导入，对于表上没有主键或者唯一索引的情况，数据就会重复导入，会造成业务上的数据重复。针对这种情况，pg_restore提供了no-data-for-failed-tables选项来防止重复数据的进入，即在表创建失败的时候，表中的数据不进行导入。建议除非在--clean的情况下(即创建对象前先删除)，不使用该选项，否则在进行数据导入的时候均启用。</p>

<p>不启用时候进行数据导入，原test表中数据记录1000000条。</p>

<pre><code>
[postgres@dang-db dump]$$PGHOME/bin/psql -U user01 -d testdb -c &#39;select count(*) from test;&#39;;

$PGHOME/bin/pg_restore -a -t test -n user01 testdb.dump -d testdb 

$PGHOME/bin/psql -U user01 -d testdb -c &#39;select count(*) from test;&#39;;  count  

---------

 1000000

(1 row)


[postgres@dang-db dump]$$PGHOME/bin/pg_restore  -t test -n user01 testdb.dump -d testdb

pg_restore: [archiver (db)] Error while PROCESSING TOC:

pg_restore: [archiver (db)] Error from TOC entry 187; 1259 24713 TABLE test user01

pg_restore: [archiver (db)] could not execute query: ERROR:  relation &quot;test&quot; already exists

    Command was: CREATE TABLE test (

    id integer NOT NULL,

    name text

);


WARNING: errors ignored on restore: 1

[postgres@dang-db dump]$$PGHOME/bin/psql -U user01 -d testdb -c &#39;select count(*) from test;&#39;;

  count  

---------

 2000000

(1 row)

</code></pre>

<p>添加 --no-data-for-failed-tables 继续导入：</p>

<pre><code>
[postgres@dang-db dump]$$PGHOME/bin/pg_restore  -t test -n user01 testdb.dump -d testdb --no-data-for-failed-tables

pg_restore: [archiver (db)] Error while PROCESSING TOC:

pg_restore: [archiver (db)] Error from TOC entry 190; 1259 24741 TABLE test user01

pg_restore: [archiver (db)] could not execute query: ERROR:  relation &quot;test&quot; already exists

    Command was: CREATE TABLE test (

    id integer NOT NULL,

    name text

);

WARNING: errors ignored on restore: 1

[postgres@dang-db dump]$$PGHOME/bin/psql -U user01 -d testdb -c &#39;select count(*) from test;&#39;;

  count  

---------

 2000000

(1 row)



[postgres@dang-db dump]$



</code></pre>

<h4 id="toc_11">恢复索引</h4>

<p>-I 选项可以单独恢复索引</p>

<pre><code>
user01@testdb:5532 &gt; \d test02

    Table &quot;user01.test02&quot;

 Column |  Type   | Modifiers 

--------+---------+-----------

 id     | integer | 

 name   | text    | 

Indexes:

    &quot;idx_test02_id&quot; btree (id)

    &quot;idx_test02_id1&quot; btree (id) WHERE id &lt; 10



user01@testdb:5532 &gt; drop index idx_test02_id;

DROP INDEX

user01@testdb:5532 &gt; \d test02                

    Table &quot;user01.test02&quot;

 Column |  Type   | Modifiers 

--------+---------+-----------

 id     | integer | 

 name   | text    | 

Indexes:

    &quot;idx_test02_id1&quot; btree (id) WHERE id &lt; 10


[postgres@dang-db dump]$$PGHOME/bin/pg_restore  -I idx_test02_id -n user01 testdb.dump -d testdb --verbose

pg_restore: connecting to database for restore

pg_restore: creating INDEX &quot;user01.idx_test02_id&quot;

pg_restore: setting owner and privileges for INDEX &quot;user01.idx_test02_id&quot;



user01@testdb:5532 &gt; \d test02

    Table &quot;user01.test02&quot;

 Column |  Type   | Modifiers 

--------+---------+-----------

 id     | integer | 

 name   | text    | 

Indexes:

    &quot;idx_test02_id&quot; btree (id)

    &quot;idx_test02_id1&quot; btree (id) WHERE id &lt; 10



</code></pre>

<h3 id="toc_12">2.4 恢复其他对象的定义</h3>

<h4 id="toc_13">恢复触发器</h4>

<pre><code>
user01@testdb:5532 &gt; select tgname from pg_trigger;

       tgname        

---------------------

 delete_test_trigger

(1 row)


user01@testdb:5532 &gt; drop trigger delete_test_trigger on test;

DROP TRIGGER


$PGHOME/bin/pg_restore  -T delete_test_trigger -n user01 testdb.dump -d testdb --verbose




user01@testdb:5532 &gt; select tgname from pg_trigger;   

       tgname        

---------------------

 delete_test_trigger

(1 row)

</code></pre>

<h4 id="toc_14">恢复函数</h4>

<ul>
<li> 删除现有函数</li>
</ul>

<pre><code>user01@testdb:5532 &gt; \sf test_delete_trigger
CREATE OR REPLACE FUNCTION user01.test_delete_trigger()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin 
insert into  test_delete values (old.id,old.name);
return old;
end;
$function$
user01@testdb:5532 &gt; drop function test_delete_trigger();
DROP FUNCTION
user01@testdb:5532 &gt; \sf test_delete_trigger             
ERROR:  function &quot;test_delete_trigger&quot; does not exist
</code></pre>

<ul>
<li>-P 参数恢复函数</li>
</ul>

<pre><code>[postgres@dang-db dump]$$PGHOME/bin/pg_restore  -P &#39;test_delete_trigger()&#39; -n user01 testdb.dump -d testdb --verbose
pg_restore: connecting to database for restore
pg_restore: creating FUNCTION &quot;user01.test_delete_trigger()&quot;
pg_restore: setting owner and privileges for FUNCTION &quot;user01.test_delete_trigger()&quot;

user01@testdb:5532 &gt; \sf test_delete_trigger
CREATE OR REPLACE FUNCTION user01.test_delete_trigger()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin 
insert into  test_delete values (old.id,old.name);
return old;
end;
$function$
</code></pre>

<h3 id="toc_15">2.5 其他一些参数选项</h3>

<ul>
<li><p>--no-tablespaces 在恢复的时候不指定表空间，所有的对象默认恢复到所在数据库的默认表空间。对于数据的迁移和新环境的搭建很有帮助。</p></li>
<li><p>--if-exists 配合 --clean参数一起使用，在删除对象的时候加上 if exists。</p></li>
<li><p>-f filename 可以利用该参数将备份文件内容恢复到文本文件中。</p></li>
</ul>

<h2 id="toc_16">3.待加强的功能</h2>

<ul>
<li><p>同样，希望可以在恢复的时候可以根据对象类型恢复同类全部对象。</p></li>
<li><p>可以提供将参数选项写入配置文件，然后从配置文件中读取的功能。</p></li>
<li><p>可以通过扩展的dblink实现不落地迁移数据。</p></li>
</ul>

</div></body>

</html>
